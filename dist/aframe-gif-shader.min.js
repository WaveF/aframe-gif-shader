AFRAME.registerComponent("gif-shader",{schema:{src:{default:""},speed:{default:1},play:{default:!0}},init(){this.frameIdx=0,this.frameCnt=0,this.delayTimes=[],this.frames=[],this.rawFrameTimes=[],this.rawFrames=[],this.loopCnt=0,this.lastFrameTime=0,this.frameSkip=1,this.cnv=document.createElement("canvas"),this.ctx=this.cnv.getContext("2d")},update(e){const t=AFRAME.utils.diff(e,this.data);if(t.hasOwnProperty("src"))this.loadGIF(this.data.src,this.onGIFLoaded.bind(this),this.onGIFLoadError.bind(this));else if(t.hasOwnProperty("speed")){let e=this.data.speed;this.delayTimes=this.rawFrameTimes.map((t=>t/e))}},onGIFLoaded(e,t,a){this.rawFrameTimes=e,this.rawFrames=a;let s=this.data.speed;s<1&&(s=1),this.delayTimes=this.rawFrameTimes.map((e=>e/s)),this.frames=this.rawFrames,this.loopCnt=t||0,this.frameCnt=e.length,this.cnv.width=a[0].width,this.cnv.height=a[0].height,this.texture=new THREE.Texture(this.cnv),this.texture.minFilter=THREE.LinearFilter,this.texture.magFilter=THREE.LinearFilter,this.el.getObject3D("mesh").material=new THREE.MeshBasicMaterial({map:this.texture,transparent:!0,alphaTest:.5})},onGIFLoadError(e){},loadGIF(e,t,a){var s=new XMLHttpRequest;s.open("GET",e),s.responseType="arraybuffer",s.onload=function(e){this.parseGIF(new Uint8Array(e.target.response),t,a)}.bind(this),s.onerror=function(){a&&a("loadGIF: load error")},s.send()},parseGIF(e,t,a){var s=0,i=[],r=0,h=null,n=null,d=[],l=0;if(71===e[0]&&73===e[1]&&70===e[2]&&56===e[3]&&57===e[4]&&97===e[5]){s+=13+ +!!(128&e[10])*Math.pow(2,1+(7&e[10]))*3;for(var o=e.subarray(0,s);e[s]&&59!==e[s];){var m=s,f=e[s];if(33===f){var p=e[++s];if(-1===[1,254,249,255].indexOf(p)){a&&a("parseGIF: unknown label");break}for(249===p&&i.push(10*(e[s+3]+(e[s+4]<<8))),255===p&&(l=e[s+15]+(e[s+16]<<8));e[++s];)s+=e[s];249===p&&(h=e.subarray(m,s+1))}else{if(44!==f){a&&a("parseGIF: unknown blockId");break}{for(s+=9,s+=1+ +!!(128&e[s])*(3*Math.pow(2,1+(7&e[s])));e[++s];)s+=e[s];n=e.subarray(m,s+1);const t=new Blob([o,h,n]),a=URL.createObjectURL(t);d.push(a)}}s++}}else a&&a("parseGIF: no GIF89a");if(d.length){var u=document.createElement("canvas"),c=(u.getContext("2d"),function(e){var a=new Image;a.onload=function(e,a){r++,d[a]=this,r===d.length?(null,u=null,t&&t(i,l,d)):c(++a)}.bind(a),a.src=u.toDataURL("image/gif")});u.width=d[0].width||2,u.height=d[0].height||2,d.forEach((function(e,t){var a=new Image;a.onload=function(e,t){r++,d[t]=this,r===d.length&&(r=0,c(1))}.bind(a,null,t),a.src=e}))}},updateFrame(){let e=this.frames[this.frameIdx];e&&(this.frameSkip=this.data.play?1:0,this.ctx.drawImage(e,0,0),this.texture.needsUpdate=!0,this.frameIdx=(this.frameIdx+this.frameSkip)%this.frames.length)},tick(e){!this.delayTimes||e-this.lastFrameTime<this.delayTimes[this.frameIdx]||(this.updateFrame(),this.lastFrameTime=e)}});